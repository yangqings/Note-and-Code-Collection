## 极客时间 网络协议

### 1. 协议综述

- IP是地址，有定位功能；MAC是身份证，唯一不变，无定位功能
- CIDR（无类型域间选路）可以用来判断是不是局域网内的IP
- DHCP协议主要是租用（分配、回收）IP地址
- DHCP协议能结合PXE（预启动执行环境）给电脑安装操作系统，在云计算领域大有用处

### 2. MAC层

- MAC层（媒体控制访问层）是用来解决多路访问冲突的问题
- ARP通过广播的方式来寻找MAC地址，并缓存一段时间
- 交换机有MAC地址学习能力

### 3. 交换机与VLAN

- 交换机主要是根据MAC地址转发包
- 交换机数量多的时候会遭遇环路问题
- STP协议能很好地解决环路问题，将有环路的图变成没有环路的树

### 4. ICMP与ping

ping 是基于 ICMP 协议工作的。ICMP 全称 Internet Control Message Protocol，就是互联网控制报文协议。

- ping使用查询报文：IMCP ECHO REQUEST + ICMP ECHO REPLY 两个字段标识符
- traceroute使用差错报文

### 5. 网关

离开局域网就需要将经过网关，MAC地址会改变，MAC地址是在局域网内确定主机的。

在 MAC 头里面，先是目标 MAC 地址，然后是源 MAC 地址，然后有一个协议类型，用来说明里面是 IP 协议。IP 头里面的版本号，目前主流的还是 IPv4，服务类型 TOS 在第三节讲 ip addr 命令的时候讲过，TTL 在第 7 节讲 ICMP 协议的时候讲过。另外，还有 8 位标识协议。这里到了下一层的协议，也就是，是 TCP 还是 UDP。最重要的就是源 IP 和目标 IP。先是源 IP 地址，然后是目标 IP 地址。

在任何一台机器上，当要访问另一个 IP 地址的时候，都会先判断，这个目标 IP 地址，和当前机器的 IP 地址，是否在同一个网段。怎么判断同一个网段呢？需要 CIDR 和子网掩码，这个在第三节的时候也讲过了。

如果是同一个网段，就没网关什么事情，直接将源地址和目标地址放入 IP 头中，然后通过 ARP 获得 MAC 地址，将源 MAC 和目的 MAC 放入 MAC 头中，发出去就可以了。

如果不是同一网段，就需要发往默认网关 Gateway。Gateway 的地址一定是和源 IP 地址是一个网段的。往往不是第一个，就是第二个。例如 192.168.1.0/24 这个网段，Gateway 往往会是 192.168.1.1/24 或者 192.168.1.2/24。

网关往往是一个路由器，是一个三层转发的设备。就是把 MAC 头和 IP 头都取下来，然后根据里面的内容，看看接下来把包往哪里转发的设备。

每到一个新的局域网，MAC 都是要变的，但是 IP 地址都不变。在 IP 头里面，不会保存任何网关的 IP 地址。所谓的下一跳是，某个 IP 要将这个 IP 地址转换为 MAC 放入 MAC 头。