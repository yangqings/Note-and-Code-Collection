# 虚拟内存

## 一、基本概述

**虚拟内存的三个重要功能：**

1. 将主存看作是一个存储在磁盘上的地址空间的**高速缓存**，根据需要在磁盘和主存之间来回传送数据
2. 为每个进程提供了一个一致的地址空间（虚拟地址空间）
3. 保护了每个进程空间不被其他进程破坏

**页表**：

虚拟内存的缓存系统，是需要软件和硬件共同完成的，包括操作系统、MMU中的地址翻译硬件，和存储在物理内存的页表（page table）数据结构。

**页表**将虚拟地址映射到物理地址，每次**地址翻译硬件**将虚拟地址转换物理地址时，读取页表，**操作系统**负责维护页表内容，以及磁盘和DRAM之间来回传送页。

1. 





### Linux的虚拟内存系统

虚拟内存区域

缺页异常处理

#### 内存映射

普通文件

匿名文件

内核维护着专门的**交换文件**（swap file），也叫交换空间或者交换区域。交换空间限制着当前运行着的进程能够分配的虚拟页面的总数。

### fork函数

​	fork函数被调用时，内核为新进程创建各种数据结构，分配唯一的PID；创建当前进程的mm_struct、区域结构、和页表的原样副本；将两个进程中的每个页面标记为只读，并将两个进程中的每个区域结构都标记为私有的写时复制。

### exceve函数

可以在当前进程中加载并运行包含在可执行文件a.out中的程序。步骤：

- 删除已经存在的用户区域

  删除当前进程虚拟地址的用户部分中已经存在的区域结构

- 映射私有区域

  新程序代码、数据、bss和栈区域创建新的区域结构。（私有的、写时复制）

  代码和数据区域被映射为a.out文件中的.text和.data区，bss区域是请求二进制零，映射到匿名文件，大小包含在a.out文件中

- 映射共享区域

- 设置程序计数器（PC）

### mmap函数

创建新的虚拟内存区域，并将对象映射到区域中

mumap（）函数删除虚拟内存的空间



描述申请4g内存空间的整个流程。