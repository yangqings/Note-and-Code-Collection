### 静态链接

1. #### 空间与地址分配

   现在链接器空间分配策略一般采用：相似段合并。

   链接器为目标文件分配地址和空间：

   1. 输出的可执行文件的空间（.bss段不分配）

   2. 装载后的虚拟地址中的虚拟空间（.bss段需要分配）书本主要讨论这部分

   **链接过程：**

   1. 第一步：**空间和地址分配：**扫描输入的目标文件，获得各个段的的长度、属性和位置，符号定义和符号引用收集到符号表（全局符号表）。段合并，输出合并后各个段长度与位置，建立映射关系。
   2. 第二步：**符号解析与重定位：**使用第一步的信息，读取各个段的数据和重定位信息，进行符号解析和重定位、调整代码中的地址。核心步骤。

   ```bash
   $ ld a.o b.o -e main -o ab
   ```

   - -e main 表示将main函数作为程序入口，默认为_start
   - -o ab 表示将链接输出文件名为ab，默认a.out

2. #### 符号解析与重定位

   未进行重定位步骤的时候，.txt段的起始地址是0x00000000

   对于引用的外部符号（比如在别的.o文件中函数）的入口地址暂时设为0x00

   ELF文件必须要有重定位表（relocation table），.txt段有需要重定位，就会有.rel.txt的段保存了代码段的重定位表

   ```shell
   $ objdump -r a.o
   ```

   -r ：查看重定位表

   ```shell
   readelf -s a.o
   ```

   查看a.o的符号表

3. #### COMMON块

   弱符号机制允许同一个若符号定义在多个目标文件，但是有可能类型不一样，多符号定义类型不一致的情况：

   - 两个或者两个以上强符号类型不一致（非法）
   - 有一个强符号，其他都是弱符号，类型不一致（链接器处理）
   - 两个或者两个以上弱符号类型不一致（链接器处理）

   弱符号类型冲突，编译器会以目标文件COMMON块（Common Block）空间大的为准。（临时使用空间）

   编译器将未初始化的全局变量定义为弱符号。

   如果链接过程中有弱符号大小大于强符号，ld 链接器会报警告

   ```bash
   ld: warning: alignment 4 of symbol 'global' in a.o is smaller than 8 in b.o
   ```

   GCC " -fno-common "允许将所有未初始化的全局变量不以COMMON块的形式处理，或者使用

   _ _ attribute _ _(（nocommon）) ;

4. #### C++相关

   4.1 **重复代码消除：**模板、虚函数、内联函数、默认构造函数、默认拷贝构造函数、赋值操作符等等

   4.2 **C++与ABI：**

   ​		不同编译器编译的目标文件能否链接？MSVC编译的目标文件PE/COFF格式，GCC编译的ELF格式

   ​		必须满足如下：

   - 采用相同的目标文件格式
   - 相同的符号变量标准
   - 变量的内存分布方式相同
   - 函数的调用方式相同

   符号修饰、变量内存布局、函数调用方式等跟可执行代码二进制兼容性相关的内容称为**ABI（Application Binary Interface）**

   4.2 **影响C语言ABI兼容性的因素：**

   - 内置类型（int、float、double）大小、存放方式（大小端）
   - 组合类型....P116

5. #### 静态库链接

   库函数一般以函数为单位作为一个目标文件，为了避免在将多个函数写在一个目标文件，链接时引入了许多不需要的代码。

6. #### 链接过程控制

   特殊的程序编译：操作系统内核、BIOS、Bootloader、内核程序或者脱离操作系统的硬盘分区软件等。往往需要指定段虚拟地址、段名称、存放顺序等

   

7. #### BFD库

   BFD（Binary File Descriptor library）是GUN一个子项目，希望通过一种统一的接口来处理不同目标文件格式。

   现在的GCC、链接器ld、调试器GDB、binutils的其他工具都是通过BFD库来处理目标文件，而不是直接直接操作目标文件。

   如果需要新支持一种目标文件格式，在BFD库里面添加新格式即可，不需要修改编译器和链接器。

   BFD库软件包名称（binutils-dev）

8. #### 总结

   以后再说~
   
   常用的命令：
   
   ```shell
   $ objdump -d xxx       #反汇编
   $ readelf              #Display information about the contents of ELF format files
   ```
   
   

